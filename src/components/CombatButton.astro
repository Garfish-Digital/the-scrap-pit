---
// CombatButton.astro - Brutalist Combat Sports Button Component
interface Props {
  text: string;
  href?: string;
  variant?: 'primary' | 'accent' | 'victory' | 'ghost';
  size?: 'small' | 'medium' | 'large' | 'mega';
  className?: string;
  target?: string;
  impact?: boolean;
  disabled?: boolean;
}

const { 
  text, 
  href, 
  variant = 'primary', 
  size = 'medium',
  className = '',
  target,
  impact = true,
  disabled = false
} = Astro.props;

const Tag = href ? 'a' : 'button';
const classes = `combat-btn combat-btn--${variant} combat-btn--${size} ${impact ? 'impact-flash' : ''} ${className}`;
---

<Tag 
  class={classes}
  href={href}
  target={target}
  disabled={disabled}
  data-text={text}
  {...(href && target ? { rel: "noopener noreferrer" } : {})}
>
  <span class="combat-btn__pre-glow" aria-hidden="true"></span>
  <span class="combat-btn__text">{text}</span>
  <span class="combat-btn__impact" aria-hidden="true"></span>
  <span class="combat-btn__satisfaction" aria-hidden="true"></span>
</Tag>

<style lang="scss">
@import '../styles/variables';
@import '../styles/color_filters';

.combat-btn {
  position: relative;
  display: inline-block;
  border: none;
  background: none;
  cursor: pointer;
  text-decoration: none;
  font-family: $font-body;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  transition: all $transition-quick;
  overflow: hidden;
  
  // Disabled state
  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }
  
  // Pre-hover glow effect
  &__pre-glow {
    position: absolute;
    top: -4px;
    left: -4px;
    width: calc(100% + 8px);
    height: calc(100% + 8px);
    background: radial-gradient(ellipse at center, transparent 60%, rgba($blood-red, 0.15) 100%);
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.4s ease-out;
    z-index: 0;
    pointer-events: none;
    clip-path: polygon(15% 0%, 85% 0%, 100% 15%, 100% 85%, 85% 100%, 15% 100%, 0% 85%, 0% 15%);
    
    // Debug visibility
    // border: 1px dashed red; // Uncomment to see the glow element
  }
  
  // Button text
  &__text {
    position: relative;
    z-index: 3;
    display: block;
    transition: all $transition-quick;
  }
  
  // Impact effect overlay
  &__impact {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba($ghost-white, 0.9);
    opacity: 0;
    transform: scale(0.8);
    transition: all $impact-duration;
    z-index: 2;
    clip-path: polygon(40% 0%, 40% 40%, 100% 40%, 60% 40%, 60% 100%, 60% 60%, 0% 60%, 40% 60%);
  }
  
  // Post-click satisfaction feedback
  &__satisfaction {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border: 2px solid rgba($championship-gold, 0.8);
    border-radius: 50%;
    opacity: 0;
    transform: translate(-50%, -50%) scale(0);
    transition: all 0.6s ease-out;
    z-index: 1;
    pointer-events: none;
  }
  
  // Multi-stage interaction states
  &.pre-hover {
    .combat-btn__pre-glow {
      opacity: 1;
      transform: scale(1.1);
    }
    
    // Debug: Add visible border when pre-hover is active
    border: 2px solid rgba($blood-red, 0.5) !important;
  }
  
  &.satisfaction-active {
    .combat-btn__satisfaction {
      width: 100px;
      height: 100px;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      
      // Fade out after expansion
      animation: satisfaction-ring 0.6s ease-out forwards;
    }
    
    // Debug: Add visible indicator when satisfaction is active
    &::after {
      content: 'âœ“';
      position: absolute;
      top: -10px;
      right: -10px;
      background: $championship-gold;
      color: $text-primary;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      z-index: 10;
    }
  }
  
  // Variants
  &--primary {
    background: $bg-primary;
    color: $text-primary;
    border: $border-primary;
    
    .combat-btn__pre-glow {
      background: radial-gradient(ellipse at center, transparent 60%, rgba($iron-black, 0.15) 100%);
    }
    
    &:hover {
      transform: translate(-3px, -3px);
      box-shadow: $shadow-harsh;
    }
    
    &:active {
      transform: translate(-1px, -1px) scale($impact-scale);
      box-shadow: 2px 2px 0 $iron-black;
    }
  }
  
  &--accent {
    background: $blood-red;
    color: $text-inverse;
    border: $border-thick solid $blood-red;
    
    .combat-btn__pre-glow {
      background: radial-gradient(ellipse at center, transparent 50%, rgba($blood-red, 0.25) 100%);
    }
    
    &:hover {
      transform: translate(-3px, -3px);
      box-shadow: $shadow-accent;
      background: darken($blood-red, 10%);
    }
    
    &:active {
      transform: translate(-1px, -1px) scale($impact-scale);
      box-shadow: 2px 2px 0 darken($blood-red, 20%);
    }
  }
  
  &--victory {
    background: $championship-gold;
    color: $text-primary;
    border: $border-thick solid $championship-gold;
    
    .combat-btn__pre-glow {
      background: radial-gradient(ellipse at center, transparent 50%, rgba($championship-gold, 0.25) 100%);
    }
    
    &:hover {
      transform: translate(-3px, -3px);
      box-shadow: $shadow-victory;
      background: darken($championship-gold, 10%);
    }
    
    &:active {
      transform: translate(-1px, -1px) scale($impact-scale);
      box-shadow: 2px 2px 0 darken($championship-gold, 20%);
    }
  }
  
  &--ghost {
    background: transparent;
    color: $text-primary;
    border: $border-primary;
    
    .combat-btn__pre-glow {
      background: radial-gradient(ellipse at center, transparent 60%, rgba($iron-black, 0.1) 100%);
    }
    
    &:hover {
      background: $bg-primary;
      transform: translate(-2px, -2px);
      box-shadow: $shadow-harsh;
    }
    
    &:active {
      transform: scale($impact-scale);
      background: darken($bg-primary, 5%);
    }
  }
  
  // Sizes
  &--small {
    padding: $space-xs $space-sm;
    font-size: $font-size-small;
    
    .combat-btn__text {
      letter-spacing: 0.05em;
    }
  }
  
  &--medium {
    padding: $space-sm $space-md;
    font-size: $font-size-normal;
  }
  
  &--large {
    padding: $space-md $space-lg;
    font-size: $font-size-medium;
    border-width: $border-mega;
    
    &:hover {
      transform: translate(-4px, -4px);
    }
  }
  
  &--mega {
    padding: $space-lg $space-xl;
    font-size: $font-size-large;
    border-width: $border-mega;
    
    .combat-btn__text {
      font-family: $font-display;
      letter-spacing: 0.05em;
    }
    
    &:hover {
      transform: translate(-6px, -6px);
      // Use default shadow - variants will override this
      box-shadow: 8px 8px 0 $iron-black;
    }
    
    // Variant-specific mega shadows
    &.combat-btn--accent:hover {
      box-shadow: 8px 8px 0 $blood-red;
    }
    
    &.combat-btn--victory:hover {
      box-shadow: 8px 8px 0 $championship-gold;
    }
    
    &.combat-btn--ghost:hover {
      box-shadow: 8px 8px 0 $iron-black;
    }
  }
  
  // Impact flash effect
  &.impact-flash {
    &:active,
    &.flash {
      .combat-btn__impact {
        opacity: 1;
        transform: scale(1);
      }
    }
  }
  
  // Special effects
  &.brutalist-shadow {
    box-shadow: $shadow-harsh;
    
    &:hover {
      box-shadow: 
        $shadow-harsh,
        inset 0 0 10px rgba($iron-black, 0.1);
    }
  }
  
  &.gritty-texture {
    @extend .gritty-overlay;
  }
  
  // Responsive adjustments
  @media (max-width: $breakpoint-md) {
    &--mega {
      padding: $space-md $space-lg;
      font-size: $font-size-medium;
    }
    
    &--large {
      padding: $space-sm $space-md;
      font-size: $font-size-normal;
    }
  }
  
  // Focus states for accessibility
  &:focus {
    outline: 2px solid $blood-red;
    outline-offset: 2px;
  }
  
  // Animation for loading state
  &.loading {
    .combat-btn__text {
      opacity: 0.7;
    }
    
    &::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
  }
}

// Loading animation
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

// Satisfaction feedback ring animation
@keyframes satisfaction-ring {
  0% {
    width: 0;
    height: 0;
    opacity: 1;
    border-width: 3px;
  }
  50% {
    width: 80px;
    height: 80px;
    opacity: 0.8;
    border-width: 2px;
  }
  100% {
    width: 120px;
    height: 120px;
    opacity: 0;
    border-width: 1px;
  }
}

// Hover effect for parent containers
.combat-btn-group {
  display: flex;
  gap: $space-md;
  flex-wrap: wrap;
  align-items: center;
  
  &.center {
    justify-content: center;
  }
  
  &.stack {
    flex-direction: column;
    align-items: stretch;
  }
  
  @media (max-width: $breakpoint-md) {
    gap: $space-sm;
    
    &.responsive-stack {
      flex-direction: column;
      
      .combat-btn {
        width: 100%;
        text-align: center;
      }
    }
  }
}
</style>

<script>
// Multi-Stage Combat Button Interactions - Optimized
(() => {
  let buttonsInitialized = false;
  const PROXIMITY_THRESHOLD = 60;
  
  function initCombatButtons() {
    if (buttonsInitialized) return;
    
    const buttons = document.querySelectorAll('.combat-btn');
    if (buttons.length === 0) return;
    
    console.log('Initializing', buttons.length, 'combat buttons');
    
    // Single mousemove listener for all buttons (performance optimization)
    let currentMouseX = 0;
    let currentMouseY = 0;
    
    document.addEventListener('mousemove', (e) => {
      currentMouseX = e.clientX;
      currentMouseY = e.clientY;
      
      // Check proximity for all buttons
      buttons.forEach(button => {
        const rect = button.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const distance = Math.sqrt(
          Math.pow(currentMouseX - centerX, 2) + 
          Math.pow(currentMouseY - centerY, 2)
        );
        
        // Stage 1: Pre-hover glow when cursor is near
        if (distance <= PROXIMITY_THRESHOLD && !button.matches(':hover')) {
          button.classList.add('pre-hover');
        } else if (distance > PROXIMITY_THRESHOLD) {
          button.classList.remove('pre-hover');
        }
      });
    });
    
    // Individual click handlers for satisfaction feedback
    buttons.forEach(button => {
      button.addEventListener('click', () => {
        // Remove any previous satisfaction animation
        button.classList.remove('satisfaction-active');
        
        // Trigger satisfaction feedback after a brief delay
        setTimeout(() => {
          button.classList.add('satisfaction-active');
          
          // Clean up after animation completes
          setTimeout(() => {
            button.classList.remove('satisfaction-active');
          }, 600);
        }, 100);
      });
    });
    
    // Clear pre-hover when mouse leaves window
    document.addEventListener('mouseleave', () => {
      buttons.forEach(button => {
        button.classList.remove('pre-hover');
      });
    });
    
    buttonsInitialized = true;
    console.log('Combat buttons initialized successfully');
  }
  
  // Initialize immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCombatButtons);
  } else {
    initCombatButtons();
  }
  
  // Re-initialize for Astro page transitions
  document.addEventListener('astro:after-swap', () => {
    buttonsInitialized = false;
    initCombatButtons();
  });
})();
</script>